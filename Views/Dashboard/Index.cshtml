@using Microsoft.AspNetCore.Identity
  @inject UserManager<ApplicationUser> UserManager
  @inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = "KPI Dashboard";
}

<div class="container mt-4">
    <h2 class="text-center">KPI Dashboard</h2>

    <!-- Filter Controls -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="dateRangeFrom" class="form-label">From:</label>
            <input type="text" id="dateRangeFrom" class="form-control datepicker" />
        </div>
        <div class="col-md-4">
            <label for="dateRangeTo" class="form-label">To:</label>
            <input type="text" id="dateRangeTo" class="form-control datepicker" />
        </div>
        <div class="col-md-4">
            <label for="department" class="form-label">Department:</label>
            <select id="department" class="form-select">
                <option value="All">All</option>
                <option value="Admission">Admission</option>
                <option value="Visa">Visa</option>
            </select>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-12">
            <label for="user" class="form-label">User:</label>
            <select id="user" class="form-select">
                @foreach (var u in ViewBag.Users)
                {
                    <option value="@u">@u</option>
                }
            </select>
        </div>
    </div>
    <div class="text-center mb-3">
        <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
    </div>

    <!-- Visual Analytics Placeholders -->
    <div class="row">
        <div class="col-md-12">
            <canvas id="lineChart" style="max-height: 400px;"></canvas>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-6">
            <canvas id="pieChart" style="max-height: 400px;"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="barChart" style="max-height: 400px;"></canvas>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div id="metricCards" class="row text-center"></div>
        </div>
    </div>

    <!-- Download Report -->
    <div class="text-center mt-4">
        <button id="downloadReport" class="btn btn-secondary">Download Report</button>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize datepickers
            $('.datepicker').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            }).datepicker('setDate', new Date(new Date().setDate(new Date().getDate() - 30)))
              .on('changeDate', function () {
                  $('#applyFilters').trigger('click');
              });

            // Apply filters
            $('#applyFilters').click(function () {
                var startDate = $('#dateRangeFrom').val() ? new Date($('#dateRangeFrom').val()) : null;
                var endDate = $('#dateRangeTo').val() ? new Date($('#dateRangeTo').val()) : null;
                var department = $('#department').val();
                var user = $('#user').val();

                $.post('@Url.Action("GetDashboardData", "Dashboard")', {
                    startDate: startDate,
                    endDate: endDate,
                    department: department,
                    user: user
                }, function (data) {
                    alert(data.message); // Placeholder for now
                });
            });

            // Download report (placeholder)
            $('#downloadReport').click(function () {
                alert('Download functionality will be implemented in Step 4');
            });
        });
    </script>
  }